function [IdxPBCIn,IdxPBCOut,TransVec,BasisVec]=IndexPBC3D(Nodes,di,PBC0,minNodeDist)
numPBC=size(PBC0,1);
mindDist=minNodeDist;
sizeVec=zeros(numPBC,1);
% maxLength=sqrt((PBC0(4)-PBC0(1))^2+(PBC0(5)-PBC0(2))^2+(PBC0(6)-PBC0(3))^2);
maxLength=max(max(((PBC0(:,4)-PBC0(:,1)).^2+(PBC0(:,5)-PBC0(:,2)).^2+(PBC0(:,6)-PBC0(:,3)).^2).^(0.5)));
nmax=ceil(maxLength/mindDist)+1;
IdxPBC=zeros(numPBC,nmax*di);
% BasisVec=zeros(numPBC/2,2);
BasisVec=[PBC0(2:2:end,1)-PBC0(1:2:end,1),PBC0(2:2:end,2)-PBC0(1:2:end,2),PBC0(2:2:end,3)-PBC0(1:2:end,3)];

for i=1:numPBC
%     Bvecidx=ceil(i/2);
    PBC00=PBC0(i,:);
    length=sqrt((PBC00(4)-PBC00(1))^2+(PBC00(5)-PBC00(2))^2+(PBC00(6)-PBC00(3))^2);
%     BasisVec(Bvecidx,1:2)=[PBC00(3)-PBC00(1) PBC00(4)-PBC00(2)];
    DBCVecY=linspace(PBC00(2),PBC00(5),round(length/(mindDist*0.25),0))';
    DBCVecX=linspace(PBC00(1),PBC00(4),round(length/(mindDist*0.25),0))';
    DBCVecZ=linspace(PBC00(3),PBC00(6),round(length/(mindDist*0.25),0))';
    DBCVec=[ones(round(length/(mindDist*0.25),0),3)'.*[PBC00(1) PBC00(2) PBC00(3)]']';
    DBCVec(1:size(DBCVecX),1)= DBCVecX;
    DBCVec(1:size(DBCVecY),2)= DBCVecY;
    DBCVec(1:size(DBCVecY),3)= DBCVecZ;
%   Idx0=transpose(unique(nonzeros(knnsearch(Nodes(:,1:2),DBCVec))));
    Idx00=rangesearch(Nodes,DBCVec,mindDist,'SortIndices',false);
    Idx00=Idx00(~cellfun('isempty',Idx00));
    Idx0 = Cell2Vec(Idx00);
    Idx0=unique(Idx0,'stable');
    Idx0=reshape(repmat(Idx0,di,1)*di-repmat(fliplr([0:di-1])',1,size(Idx0,1)),[],1)';
    sizeVec(i,1)=size(Idx0,2);
    IdxPBC(i,1:sizeVec(i))=Idx0;
end
IdxPBC( :, ~any(IdxPBC,1) ) = [];  %delete zero columns
IdxPBCIn=reshape(IdxPBC(1:2:end,:)',[],1);
IdxPBCOut=reshape(IdxPBC(2:2:end,:)',[],1);
IdxPBCIn(~any(IdxPBCIn,2),: ) = [];
IdxPBCOut(~any(IdxPBCOut,2),: ) = [];
% DiCoords=zeros(size(Nodes,1)*2,2);
% DiCoords(1:2:size(Nodes,1)*2-1,:)=Nodes(:,1:2);
% DiCoords(2:2:size(Nodes,1)*2,:)=Nodes(:,1:2);
DiCoords=[reshape(repmat(Nodes(:,1)',di,1),[],1) reshape(repmat(Nodes(:,2)',di,1),[],1)];
TransVec(:,1)=DiCoords(IdxPBCOut,1)-DiCoords(IdxPBCIn,1);
TransVec(:,2)=DiCoords(IdxPBCOut,2)-DiCoords(IdxPBCIn,2);